<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Model Training</title>
</head>
<body>
  <h2>Simulated Model Training Between JavaScript and Python</h2>
  <!-- <button id="sendButton" onclick="sendMessage()" disabled>Send Message to Python</button> -->
  <div id="messages"></div>

  <script>
    let pc = new RTCPeerConnection();
    let signaling = new WebSocket('ws://localhost:8765');
    let dataChannel = pc.createDataChannel("training");
    let sessionCode = "mySessionCode"; // Replace with user input
    let maxUsers = 3; // Replace with user input
    let rounds = 5;
    let currentRound = 0;

    signaling.onopen = () => {
        signaling.send(JSON.stringify({
            action: "join_session",
            session_code: sessionCode,
            max_users: maxUsers
        }));
    };

    signaling.onmessage = async (message) => {
        const data = JSON.parse(message.data);

        if (data.action === "start_session") {
            console.log("Session started. Peers:", data.peers);
            setupPeerConnections(data.peers);
        }
        if (data.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === "offer") {
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              signaling.send(JSON.stringify({
                  sdp: pc.localDescription,
                  target: data.source  // Send the answer back to the source peer
              }));
          }
        } else if (data.candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    };

    async function setupPeerConnections(peers) {
    for (const peerPort of peers) {
        // Create offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // Send SDP offer to signaling server with target peer
        signaling.send(JSON.stringify({
            sdp: pc.localDescription,
            target: peerPort  // Include target peer's port
        }));
    }
}

    dataChannel.onmessage = async (event) => {
        const data = JSON.parse(event.data);

        if (data.weights && currentRound < rounds) {
            console.log(`Round ${currentRound + 1}: Received weights`);
            currentRound++;
            await simulateTraining();
            dataChannel.send(JSON.stringify({ weights: data.weights, round: currentRound }));
        }
    };

    async function simulateTraining() {
        console.log(`Training for round ${currentRound}`);
        return new Promise(resolve => setTimeout(resolve, 1000)); // Simulate training
    }
  </script>

</body>
</html>
